/* 
   KODE LENGKAP GOOGLE APPS SCRIPT (UPDATE V3 - SUPPORTS EDIT/UPDATE)
   
   FITUR BARU:
   1. Mendapatkan `rowIndex` (nomor baris) untuk setiap data.
   2. Menangani aksi `action=update_registrant` untuk mengedit data yang sudah ada.
   
   CARA PASANG:
   1. Buka script.google.com project Anda.
   2. Hapus SEMUA kode lama.
   3. Copy-Paste kode ini.
   4. Isi SHEET_NAME dan FOLDER_ID.
   5. Klik DEPLOY > NEW DEPLOYMENT (Wajib User Baru agar perubahan aktif).
*/

// --- KONFIGURASI (WAJIB DIISI) ---
var SHEET_NAME = "Sheet1"; // Nama Tab Sheet. Pastikan sama persis!
var FOLDER_ID = "MASUKAN_ID_FOLDER_GOOGLE_DRIVE_DISINI"; 

// -----------------------------------------------------------------------

function doGet(e) {
  var action = e.parameter.action;

  // Endpoint untuk Dashboard Admin
  if (action == 'get_registrants') {
    return getRegistrants();
  }
  
  return ContentService.createTextOutput("Server Berjalan Normal. V3");
}

function doPost(e) {
  var lock = LockService.getScriptLock();
  lock.tryLock(10000);

  try {
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
    if (!sheet) return responseJSON("error", "Sheet tidak ditemukan: " + SHEET_NAME);

    var rawData = e.postData.contents;
    var data = JSON.parse(rawData);
    var action = e.parameter.action || data.action; // Support parameter param atau body json

    // --- LOGIKA UPDATE DATA ---
    if (action === "update_registrant") {
       return handleUpdate(sheet, data);
    }

    // --- LOGIKA INSERT BARU (DEFAULT) ---
    // 1. Ambil Header
    var headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    var nextRow = sheet.getLastRow() + 1;
    var newRow = [];
    
    // 2. Mapping Data
    for (var i = 0; i < headers.length; i++) {
      var headerName = headers[i];
      var value = getValueByKey(data, headerName); // Cek dengan spasi atau underscore

      // Timestmap
      if (headerName === "Timestamp" || headerName === "Waktu") {
        newRow.push(new Date());
        continue;
      }

      // Handle File Base64
      if (typeof value === 'string' && value.includes("base64,")) {
        var fileName = headerName + "_" + (data["Nama_Santri_Baru"] || "File") + "_" + new Date().getTime();
        var fileUrl = uploadToDrive(value, FOLDER_ID, fileName);
        newRow.push(fileUrl);
      } else {
        newRow.push(value ? "'" + value : ""); 
      }
    }

    // 3. Simpan
    sheet.appendRow(newRow);
    return responseJSON("success", "Data berhasil disimpan di baris " + nextRow);

  } catch (e) {
    return responseJSON("error", e.toString());
  } finally {
    lock.releaseLock();
  }
}

// --- FUNGSI UPDATE DATA ---
function handleUpdate(sheet, data) {
  var rowIndex = parseInt(data.row_index); // Wajib kirim row_index dari frontend
  if (!rowIndex || rowIndex < 2) return responseJSON("error", "Invalid Row Index");

  var headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  
  // Loop setiap kolom, jika ada data baru dikirim, update.
  for (var i = 0; i < headers.length; i++) {
    var headerName = headers[i];
    
    // Kita cek apakah frontend mengirim data untuk kolom ini?
    // Gunakan logika pencarian key yang sama (spasi/underscore)
    var newValue = getValueByKey(data, headerName);

    // Jika newValue ada (tidak undefined), maka kita update cell tersebut
    // Note: Jika ingin menghapus data, frontend harus kirim string kosong "", bukan undefined.
    if (newValue !== undefined) {
      // Cek apakah ini file baru?
      if (typeof newValue === 'string' && newValue.includes("base64,")) {
         var fileName = headerName + "_REVISED_" + new Date().getTime();
         newValue = uploadToDrive(newValue, FOLDER_ID, fileName);
      }
      
      // Update Cell (Row Index, Kolom ke-i+1)
      sheet.getRange(rowIndex, i + 1).setValue(newValue);
    }
  }

  return responseJSON("success", "Data baris " + rowIndex + " berhasil diupdate.");
}

// --- HELPER FUNCTIONS ---

function getRegistrants() {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  var data = sheet.getDataRange().getValues();
  var headers = data[0];
  var requests = [];

  for (var i = 1; i < data.length; i++) {
    var row = data[i];
    var obj = {};
    
    // PENTING: Kirim Nomor Baris (Row Index) agar Frontend tahu data mana yang diedit
    obj['row_index'] = i + 1; 

    for (var j = 0; j < headers.length; j++) {
      obj[headers[j]] = row[j]; 
      
      // Versi Underscore
      var keyUnderscore = headers[j].toString().replace(/ /g, "_");
      if (keyUnderscore !== headers[j]) {
        obj[keyUnderscore] = row[j];
      }
    }
    requests.push(obj);
  }

  return responseJSON("success", requests, true); // true = isData
}

function getValueByKey(data, headerName) {
  var val = data[headerName];
  if (val === undefined) {
    val = data[headerName.replace(/ /g, "_")];
  }
  return val;
}

function uploadToDrive(base64Data, folderId, fileName) {
  try {
    if (!base64Data) return "";
    var split = base64Data.split('base64,');
    if (split.length < 2) return ""; 

    var type = split[0].split(':')[1].split(';')[0];
    var byteCharacters = Utilities.base64Decode(split[1]);
    var blob = Utilities.newBlob(byteCharacters, type, fileName);
    
    var folder;
    try { folder = DriveApp.getFolderById(folderId); } 
    catch(e) { folder = DriveApp.getRootFolder(); }
    
    var file = folder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    return "https://drive.google.com/uc?export=view&id=" + file.getId();
  } catch (e) {
    return "Error Upload: " + e.toString();
  }
}

function responseJSON(status, dataOrMessage, isData) {
  var payload = { status: status };
  if (isData) {
    payload.data = dataOrMessage;
  } else {
    if (status === 'success') payload.data = dataOrMessage; // Message di taruh di data juga gpp buat simple
    payload.message = dataOrMessage;
  }
  return ContentService.createTextOutput(JSON.stringify(payload)).setMimeType(ContentService.MimeType.JSON);
}
